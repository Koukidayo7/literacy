<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>YouTube 動的検索＆同期再生チャット</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <!-- Socket.io -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <!-- YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body { display:flex; height:100vh; font-family:sans-serif; }
    #sidebar { width:300px; background:#1f1f1f; color:#eee; padding:1rem; overflow-y:auto; }
    #main { flex:1; display:flex; flex-direction:column; }
    h2 { margin-bottom:.5rem; font-size:1.2rem; }
    input, button { width:100%; padding:.5rem; margin-bottom:.5rem; }
    #chat { height:120px; overflow-y:auto; background:#fff; color:#000; padding:.5rem; }
    #search-panel { padding:.5rem; background:#fafafa; }
    #results { max-height:200px; overflow-y:auto; }
    .video-item { display:flex; align-items:center; padding:.5rem; border-bottom:1px solid #ddd; cursor:pointer; }
    .video-item img { width:80px; height:45px; margin-right:.5rem; }
    #player-container { flex:1; background:#000; position:relative; }
    #player { width:100%; height:100%; }
    #controls { padding:.5rem; background:#222; display:flex; }
    #controls button { margin-right:.5rem; }
  </style>
</head>
<body>

  <!-- サイドバー：通話＋チャット -->
  <div id="sidebar">
    <h2>通話設定</h2>
    <input id="my-id" placeholder="Your Peer ID" readonly>
    <input id="peer-id" placeholder="相手の Peer ID">
    <button id="call-btn">通話開始</button>

    <h2>チャット</h2>
    <div id="chat"></div>
    <input id="chat-input" placeholder="メッセージを入力…">
    <button id="send-chat">送信</button>
  </div>

  <!-- メイン：検索→結果→プレイヤー -->
  <div id="main">
    <div id="search-panel">
      <input id="yt-search" placeholder="YouTube を検索…">
      <button id="search-btn">検索</button>
      <div id="results"></div>
    </div>
    <div id="player-container">
      <div id="player"></div>
    </div>
    <div id="controls">
      <button id="play-btn">再生</button>
      <button id="pause-btn">一時停止</button>
      <button id="seek-back">-10秒</button>
      <button id="seek-fwd">+10秒</button>
    </div>
  </div>

  <script>
    //----------------------------------------
    // 環境設定
    const SOCKET_SERVER = 'https://your-server.com';    // Socket.io/PeerJS host
    const YT_API_KEY    = 'YOUR_YOUTUBE_DATA_API_KEY';  // 取得した API キー
    //----------------------------------------

    // Socket.io 初期化
    const socket = io(SOCKET_SERVER);

    // PeerJS 初期化
    const peer = new Peer(undefined, {
      host: 'your-server.com',
      port: 443,
      path: '/peerjs'
    });
    let localStream, currentCall;

    peer.on('open', id => {
      document.getElementById('my-id').value = id;
    });

    peer.on('call', call => {
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(s => {
          localStream = s;
          call.answer(s);
          call.on('stream', playRemoteAudio);
          currentCall = call;
        });
    });

    document.getElementById('call-btn').onclick = () => {
      const peerId = document.getElementById('peer-id').value.trim();
      if (!peerId) return alert('相手の Peer ID を入力してください');
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(s => {
          localStream = s;
          const call = peer.call(peerId, s);
          call.on('stream', playRemoteAudio);
          currentCall = call;
        });
    };

    function playRemoteAudio(remoteStream) {
      const audio = new Audio();
      audio.srcObject = remoteStream;
      audio.play();
    }

    // チャット機能
    document.getElementById('send-chat').onclick = () => {
      const txt = document.getElementById('chat-input').value.trim();
      if (!txt) return;
      socket.emit('chat', txt);
      appendChat(`自分: ${txt}`);
      document.getElementById('chat-input').value = '';
    };
    socket.on('chat', msg => appendChat(`相手: ${msg}`));
    function appendChat(msg) {
      const div = document.createElement('div');
      div.textContent = msg;
      document.getElementById('chat').append(div);
      document.getElementById('chat').scrollTop = 1e9;
    }

    // YouTube IFrame 初期化
    let ytPlayer;
    function onYouTubeIframeAPIReady() {
      ytPlayer = new YT.Player('player', {
        height: '100%',
        width: '100%',
        videoId: '',
        playerVars: { autoplay:0, controls:0 },
        events: { onStateChange: onPlayerStateChange }
      });
    }
    function onPlayerStateChange(e) {
      const st = e.data, t = ytPlayer.getCurrentTime();
      if (st === YT.PlayerState.PLAYING) socket.emit('yt-sync', { action:'play', time:t });
      if (st === YT.PlayerState.PAUSED ) socket.emit('yt-sync', { action:'pause', time:t });
    }

    // 再生コントロール
    document.getElementById('play-btn').onclick = () => {
      const t = ytPlayer.getCurrentTime();
      ytPlayer.playVideo();
      socket.emit('yt-sync', { action:'play', time:t });
    };
    document.getElementById('pause-btn').onclick = () => {
      const t = ytPlayer.getCurrentTime();
      ytPlayer.pauseVideo();
      socket.emit('yt-sync', { action:'pause', time:t });
    };
    document.getElementById('seek-back').onclick = () => {
      const t = Math.max(0, ytPlayer.getCurrentTime() - 10);
      ytPlayer.seekTo(t, true);
      socket.emit('yt-sync', { action:'seek', time:t });
    };
    document.getElementById('seek-fwd').onclick = () => {
      const t = ytPlayer.getCurrentTime() + 10;
      ytPlayer.seekTo(t, true);
      socket.emit('yt-sync', { action:'seek', time:t });
    };

    // 動的検索＋結果表示
    document.getElementById('search-btn').onclick = searchYouTube;
    document.getElementById('yt-search').addEventListener('keyup', e => {
      if (e.key === 'Enter') searchYouTube();
    });

    function searchYouTube() {
      const q = document.getElementById('yt-search').value.trim();
      if (!q) return;
      fetch(`https://www.googleapis.com/youtube/v3/search?key=${YT_API_KEY}&part=snippet&type=video&maxResults=10&q=${encodeURIComponent(q)}`)
        .then(res => res.json())
        .then(json => {
          const container = document.getElementById('results');
          container.innerHTML = '';
          json.items.forEach(item => {
            const vid = item.id.videoId;
            const div = document.createElement('div');
            div.className = 'video-item';
            div.innerHTML = `<img src="${item.snippet.thumbnails.default.url}"><div>${item.snippet.title}</div>`;
            div.onclick = () => {
              ytPlayer.loadVideoById(vid, 0);
              socket.emit('yt-sync', { action:'load', videoId: vid });
            };
            container.append(div);
          });
        })
        .catch(err => console.error(err));
    }

    // 同期イベント受信
    socket.on('yt-sync', data => {
      switch (data.action) {
        case 'load':
          ytPlayer.loadVideoById(data.videoId, 0); break;
        case 'play':
          ytPlayer.seekTo(data.time, true);
          ytPlayer.playVideo();
          break;
        case 'pause':
          ytPlayer.seekTo(data.time, true);
          ytPlayer.pauseVideo();
          break;
        case 'seek':
          ytPlayer.seekTo(data.time, true);
          break;
      }
    });
  </script>
</body>
</html>